#!/bin/sh
#
# Load mpp modules....
#

MODULES_DIR="/lib/modules/`uname -r`"

start() {
    printf "Load mpp modules\n"
#    echo export LD_LIBRARY_PATH=/usr/lib/eyesee-mpp:/usr/lib/pdet:${LD_LIBRARY_PATH} >> /etc/profile

    insmod $MODULES_DIR/videobuf2-common.ko
    insmod $MODULES_DIR/videobuf2-memops.ko
    insmod $MODULES_DIR/videobuf2-dma-contig.ko
    insmod $MODULES_DIR/videobuf2-v4l2.ko
    insmod $MODULES_DIR/vin_io.ko
    [ -f $MODULES_DIR/gc1084_mipi.ko ] && insmod $MODULES_DIR/gc1084_mipi.ko
    [ -f $MODULES_DIR/sp1405_mipi.ko ] && insmod $MODULES_DIR/sp1405_mipi.ko
    [ -f $MODULES_DIR/gc2083_mipi.ko ] && insmod $MODULES_DIR/gc2083_mipi.ko
    [ -f $MODULES_DIR/sc2336_mipi.ko ] && insmod $MODULES_DIR/sc2336_mipi.ko
    [ -f $MODULES_DIR/sc3336_mipi.ko ] && insmod $MODULES_DIR/sc3336_mipi.ko
    [ -f $MODULES_DIR/gc4663_mipi.ko ] && insmod $MODULES_DIR/gc4663_mipi.ko
    [ -f $MODULES_DIR/f37p_mipi.ko ] && insmod $MODULES_DIR/f37p_mipi.ko
    [ -f $MODULES_DIR/nvp6158.ko ] && insmod $MODULES_DIR/nvp6158.ko
    [ -f $MODULES_DIR/os02g10_dvp.ko ] && insmod $MODULES_DIR/os02g10_dvp.ko
    [ -f $MODULES_DIR/imx258_mipi.ko ] && insmod $MODULES_DIR/imx258_mipi.ko
    [ -f $MODULES_DIR/imx386_2lane_mipi.ko ] && insmod $MODULES_DIR/imx386_2lane_mipi.ko
    [ -f $MODULES_DIR/s5k3p8_mipi.ko ] && insmod $MODULES_DIR/s5k3p8_mipi.ko
    [ -f $MODULES_DIR/actuator.ko ] && insmod $MODULES_DIR/actuator.ko
    [ -f $MODULES_DIR/dw9714_act.ko ] && insmod $MODULES_DIR/dw9714_act.ko

    insmod $MODULES_DIR/vin_v4l2.ko
    [ -f $MODULES_DIR/sunxi-ve.ko ] && insmod $MODULES_DIR/sunxi-ve.ko

    # to make sure rots decompress ready and then insmod wifi ko
    fgrep -sq running /sys/class/remoteproc/remoteproc0/state || {
    	echo start > /sys/class/remoteproc/remoteproc0/state
    }
}

stop() {
    printf "Unload mpp modules\n"

    [ -f $MODULES_DIR/sunxi-ve.ko ] && rmmod $MODULES_DIR/sunxi-ve.ko
    rmmod $MODULES_DIR/vin_v4l2.ko
    [ -f $MODULES_DIR/dw9714_act.ko ] && rmmod $MODULES_DIR/dw9714_act.ko
    [ -f $MODULES_DIR/actuator.ko ] && rmmod $MODULES_DIR/actuator.ko
    [ -f $MODULES_DIR/gc1084_mipi.ko ] && rmmod $MODULES_DIR/gc1084_mipi.ko
	[ -f $MODULES_DIR/sp1405_mipi.ko ] && rmmod $MODULES_DIR/sp1405_mipi.ko
    [ -f $MODULES_DIR/gc2083_mipi.ko ] && rmmod $MODULES_DIR/gc2083_mipi.ko
    [ -f $MODULES_DIR/sc2336_mipi.ko ] && rmmod $MODULES_DIR/sc2336_mipi.ko
    [ -f $MODULES_DIR/sc3336_mipi.ko ] && rmmod $MODULES_DIR/sc3336_mipi.ko
    [ -f $MODULES_DIR/gc4663_mipi.ko ] && rmmod $MODULES_DIR/gc4663_mipi.ko
    [ -f $MODULES_DIR/f37p_mipi.ko ] && rmmod $MODULES_DIR/f37p_mipi.ko
    [ -f $MODULES_DIR/nvp6158.ko ] && rmmod $MODULES_DIR/nvp6158.ko
    [ -f $MODULES_DIR/os02g10_dvp.ko ] && rmmod $MODULES_DIR/os02g10_dvp.ko
    [ -f $MODULES_DIR/imx258_mipi.ko ] && rmmod $MODULES_DIR/imx258_mipi.ko
    [ -f $MODULES_DIR/s5k3p8_mipi.ko ] && rmmod $MODULES_DIR/s5k3p8_mipi.ko
    rmmod $MODULES_DIR/vin_io.ko
    rmmod $MODULES_DIR/videobuf2-v4l2.ko
    rmmod $MODULES_DIR/videobuf2-dma-contig.ko
    rmmod $MODULES_DIR/videobuf2-memops.ko
    rmmod $MODULES_DIR/videobuf2-common.ko
}

case "$1" in
    start)
	start
	;;
    stop)
	stop
	;;
    restart|reload)
	stop
	start
	;;
  *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?
